<!DOCTYPE html>
<!--
  SchemeJS: Scheme in JavaScript

  Copyright 2021 Stan Switzer
    This work is licensed under a Creative Commons Attribution-ShareAlike
    4.0 International License. https://creativecommons.org/licenses/by-sa/4.0/
-->
<html>
  <head>
    <title>SchemeJS: Scheme in JavaScript</title>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="viewport" content="width=device-width">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <meta name="format-detection" content="telephone=no">
    <link rel="apple-touch-icon" href="icon128.png">
    <link rel="manifest" href="manifest.webmanifest">
    <base target="_blank"> <!-- all links open in a new tab/page -->
    <style type="text/css">
      html {
        -webkit-text-size-adjust: none
      }

      * { /* input elements lay out bizarrely without this since their borders aren't part of their size */
        box-sizing: border-box;
      }

      body {
        padding: .2em .5em;
        margin: 0em 0em;
        background-color: #f8f8f8;
        text-size-adjust: none;   /* keep mobile browsers from getting sneaky with sizing */
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
      }
      html, table  {
        font: 110% caption, sans-serif;
      }
      @media all and (orientation:landscape) {
        /* iPhone crowds the screen in portrait but has lots of padding in landscape
           because they don't give you the slot or curved corner areas. So kill the padding there. */
        body[data-device="mobile"] {
          padding: 0px 0px;
        }
      }

      /*
       * A trick to let the app switch to mobile mode on the fly.
       * Javascript flips the --device property into the
       * body element's data-device attribute, but the app
       * can change it later.
       */
      @media (hover: none) {
        body {--device: mobile;}
      }
      body:not([data-device="mobile"]) .mobile-only {
        display: none;
      }
      body[data-device="mobile"] .desktop-only {
        display: none;
      }
      body:not([data-protocol="file:"]) .local-only {
        display: none;
      }
      body[data-protocol="file:"] .remote-only {
        display: none;
      }

      /*
       * Initially-hidden help content.
       * Help contains a custom <close-button> and
       * a <div> for help content which is made scrollable.
       */
      div.help {
        padding: 0em 1em;
        background-color: #e8e8e8;
        position: absolute;
        display: none;
        top: 10%;
        left: 35%;
        right: .5em;
        bottom: .5em;
        border: .15em solid black;
        border-radius: .4em;
      }
      body[data-device="mobile"] div.help {
        padding: 0 .5em;  /* closer padding of help on mobile; every pixel counts */
      }
      div.help > close-button {
        color: #0005;  /* rather transparent black */
        font-size: 150%;
        --close-button-x-thick: 35%;
        position: absolute;
        top: .3em;
        right: .3em;
        transition: .5s;
      }
      div.help > close-button:hover {
        font-size: 170%;
        color: black;
      }
      div.help > div {
        overflow-y: auto;
        height: 100%;
      }
      dl.definitions, dl.definitions dt, dl.definitions dd {
        display: block;
      }
      dl.definitions dt {
        float: left;
        clear: right;
        margin-inline-end: 2ch;
      }
      dl.definitions dd {
        float: right;
        margin-inline-start: unset;
        width: 85%;
      }
      dl.definitions > div {
        padding-top: .5em;
        clear: both;
      }
      dl .heading {
        font-weight: bold;
      }

      div.help ul {
        padding-left: 1.25em;
      }
      div.help ul > li {
        margin: .5em;
      }
      div.help code, div.help table.example td:first-child {
        font-weight: bold;
        font-family: caption, sans-serif;
        color: #444;  /* subtle graying to offset the boldness */
      }
      div.help code.abstract {
        font-style: italic;
      }
      /* Testing affordance; example text can be stuffed into the expr box */
      div.help code:hover, div.help .stuff-text:hover,
      div.help table.stuff.example td:first-child:hover {
        cursor: pointer;
        color: #00d;
        text-decoration: underline;
        --click-action: stuff-text;
      }

      /*
       * Makes a <span> into a "button"
       */
      span.button {
        display: inline-block;
        cursor: pointer;
        padding: .2em .6em;
        background: #44f;
        border-radius: .4em;
        color: white;
      }
      span.button:hover {
        background: #0000dd;
      }
      span.button:active {
        background: #0000cc;
      }
      span.padded-button {
        padding: .2em 1.5ch;
      }

      /* greasy way to make a text-delete button in the input box */
      .clear-text-button {
        position: relative;
        width: 0;
      }
      .clear-text-button > close-button {
        position: absolute;
        bottom: .15em;
        left: -2em;
        color: white;
        --close-button-box-color: #8e8d92;
        --close-button-box-radius: 50%;
        --close-button-x-thick: 25%;
        --close-button-x-size: 55%;
        padding: .05em .4em;
      }

      /* Looks like a link but is actually a "button" */
      span.linklike {
        color: #00d;
        cursor: pointer;
        text-decoration: underline;
      }

      #container {
        display: flex;
        flex-flow: column nowrap;
        overflow: hidden;
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        margin: 0;
        padding: .25em .25em .25em .25em;
      }

      #header {
        display: flex;
        flex: 0 10 auto;
        flex-flow: row nowrap;
        width: 100%;
      }

      #lambda {
        flex: 0 0 auto;
        align-self: flex-end;
        font-size: 300%;
      }

      #header #title {
        flex: 1 0 auto;
        align-self: flex-end;
        margin-bottom: .25em;
        font-size: 150%;
      }

      #header #about {
        flex: 0 0 auto;
      }

      #output {
        /* https://geon.github.io/programming/2016/02/24/flexbox-full-page-web-app-layout */
        flex: 1 1 10em;
        overflow: scroll;
        justify-content: flex-end;
        margin-top: 0.1em;
        padding: .15em .15em .15em .15em;
        width: 100%;
        background-color: #ccc;
        border: .1em solid;
        border-radius: .4em;
      }

      #output p {
        margin: 0;
      }

      #output > div {
        position: relative;  /* so that the span can be positioned absolutely */
      }
      #output > div > div {
        overflow: scroll;
        max-height: 10em;
        margin-top: 0.1em;
        padding: .5em .5em .5em .5em;
        min-height: 2em;
        border: .1em solid;
        border-radius: .4em;
        margin-top: 0.25em;
        padding: .5em .5em .5em .5em;
      }

      #output > div.result > div {
        background-color: #ddd;
        margin-left: 1em;
      }

      #output > div.input > div {
        background-color: #eee;
      }

      #output > div.error > div {
        background-color: #fbb;
      }

      #output > div > span:first-child {
        position: absolute;  /* parent div must be position: relative */
        top: 0;
        right: 0;
        margin: 0.3em 0.3em 0 0;
        padding: 0.1em 0.25em 0.1em 0.25em;
        font-size: 90%;
        border: .1em solid;
        border-radius: .4em;
        background-color: #bbb;
      }

      /* The input box */
      div#input {
        flex: 0 0 4em;
        margin-top: 0.25em;
        padding: .5em .5em .5em .5em;
        width: 100%;
        border: .1em solid;
        border-radius: .4em;
        background-color: #eee;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="header">
        <div id="lambda">&lambda;</div>
        <div style="width: 1em;"></div>
        <div id="title"> SchemeJS: Scheme in JavaScript </div>
        <div id="about">
          <span class="button" onclick="showHelp('help-about')"> ? </span>
        </div>
      </div>
      <div id="output">
      </div>
      <div id="input">
      </div>
    </div>
    <div class="help" id="help-about">
      <close-button onclick="showHelp(null)"></close-button>
      <div>
        <h2> SchemeJS: Scheme in JavaScript </h2>
        <p> JavaScript has dynamic typing, functions, closures, and a JIT with
            a small army of crack programmers optimizing its performance.
            It’s an ideal runtime for Lisp.
            All it lacks is cons cells, an s-expression parser and printer,
            eval/apply, and a handful of Lisp primitives.
        <p> Oh, and a compier that compiles Scheme down to perfectly normal
            JavaScript functions that the JIT can work its magic on.
        <p> SchemeJS fills that gap.
        <p> It’s hard to keep JavaScript objects from sneaking into the
            Scheme world, so I decided to invite them in as first-class.
            SchemeJS is fully Lisp <i>and</i> fully JavaScript.
        <p> Learn about
            <span class="button" onclick="showHelp('help-builtin')"">built-in Scheme definitions</span> and
            <span class="button" onclick="showHelp('help-details')"">implementation details</span>.
      </div>
    </div>
    <div class="help" id="help-details">
      <close-button onclick="showHelp(null)"></close-button>
      <div>
        <h2> Something </h2>
        <p>
        <p> A-B-C. A-Always. B-Be. C-Coding.
        <p> Copyright &copy; 2021, Stan Switzer
        <div style="width: 100%">
          This work is licensed under a
          <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
            Creative Commons Attribution-ShareAlike 4.0 International License</a>.
          <br> Find source on
          <a href="https://github.com/sjswitzer/SchemeJS">GitHub</a>
          <p></p>
        </div>
      </div>
    </div>
    <div class="help" id="help-builtin">
      <close-button onclick="showHelp(null)"></close-button>
      <div>
        <h2> Built-In Functions and Constants </h2>
        <table class="stuff example">
          <dl id="builtins" class="definitions">
            <dt class="heading"> Symbol
            <dd class="heading"> Description
            <!-- definitions inserted here when SchemeJS module is loaded -->
        </dl>
      </div>
    </div>
    <script type="module" src="./CloseButton.mjs"></script>
    <script type="text/javascript">
      "use strict";

      const inputElement = document.getElementById('input');
      const outputElement = document.getElementById('output');
      const builtinsElement = document.getElementById('builtins');

      let globalScope;

      onload = importSchemeAndRunREPL()
      async function importSchemeAndRunREPL() {
        let SchemeJS = await(import("./SchemeJS.mjs"));
        console.log("MODULE", SchemeJS);
        globalScope = SchemeJS.createInstance();
        inputElement.contentEditable = 'true';
        buildBuiltinHelp(globalScope);
      }

      function escapeHTML(str) {
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      let helpStack = [];

      function showHelp(id) {
        let elts = document.querySelectorAll('div.help');
        for (let e of elts)
          e.style.display = ''; // back to inherited 'none'
        if (!id) {
          helpStack.pop();
          if (helpStack.length > 0)
            helpStack[helpStack.length-1].style.display = 'block';
          return;
        }
        id = id.split("#");
        let frag = id[1];
        id = id[0];
        let helpElement = document.getElementById(id);
        if (helpElement) {
          helpStack.push(helpElement);
          helpElement.style.display = 'block'; // inherits 'none' from "help" class
          let contentElement = helpElement.querySelector('div');
          if (contentElement) {
            contentElement.scrollTop = 0;
            if (frag) {
              let element = contentElement.querySelector(`#${frag}`);
              if (element)
                element.scrollIntoView(true);
            }
          }
        }
      }

      function buildBuiltinHelp(globalScope) {
        const IMPL_SYMBOL = globalScope["IMPL_SYMBOL"], string = globalScope.string;
        let symMap = new Map; 
        for (let sym of Object.getOwnPropertySymbols(globalScope)) {
          let val = globalScope[sym]
          let item = symMap.get(val);
          if (!item)
            symMap.set(val, { firstSym: sym, syms: [ sym ] });
          else
            item.syms.push(sym);
        }
        let symtab = [];
        for (let item of symMap.values())
          symtab.push({ key: item.firstSym.description.toLowerCase(), syms: item.syms });
        symtab.sort((a, b) => a.key < b.key ? -1 : 1);
        function textElement(type, text) {
          let element = document.createElement(type);
          element.textContent = text;
          return element;
        }
        for (let { syms } of symtab) {
          let group = document.createElement('div');
          builtinsElement.appendChild(group);
          for (let sym of syms)
            group.appendChild(textElement('dt', sym.description));
          let name = syms[0].description;
          let dd = document.getElementById(`dd-$name`);
          if (!dd)
            dd = textElement('dd', "TBD");
          group.appendChild(dd);
          let value = globalScope[syms[0]];
          if (typeof value === 'function') {
            let impl = value[IMPL_SYMBOL];
            if (!impl) impl = string(value);
            if (impl.length < 50)
              group.appendChild(textElement('dd', `Impl: ${impl}`));
          } else {
            let valStr = string(value);
            if (valStr.length < 50)
              group.appendChild(textElement('dd', `Value: ${string(value)}`));
          }
        }
      }

      const LOCAL_STORAGE_KEY = `SchemeJS-${location.pathname}`;
      let appVersion = "0.0";  // filled in later
      let persistedState = {};

      function saveState() {
        const localStorage = window.localStorage;
        if (!localStorage)
          return false;
        persistedState.version = appVersion;
        let json = JSON.stringify(wad);
        try {
          localStorage.setItem(LOCAL_STORAGE_KEY, json);
          return true;
        }
        catch (e) {
        }
        return false;
      }

      function loadState() {
        const localStorage = window.localStorage;
        if (!localStorage)
          return false;
        let json = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (!json)
          return false;
        let wad;
        try {
          wad = JSON.parse(json);
        } catch (_) {
          //  ¯\_(ツ)_/¯
        }
        if (typeof wad !== 'object')
          return false;
        let appVer = appVersion.split('.'), saveVer = wad.version.split('.');
        if (!(Number(saveVer[0]) <= Number(appVer[0])))  // handles undefined implicitly
          return false;
        persistedState = wad;
        return true;
      }

      addExampleStuffs();
      function addExampleStuffs() {
        document.documentElement.addEventListener('click', function(event) {
          let element = event.target;
          while (element) {
            let styles = window.getComputedStyle(element);
            let action = styles.getPropertyValue("--click-action");
            if (action.trim() === "stuff-text") {
              // TODO
              return;
            }
            element = element.parentElement;
          }
        });
      }

      document.body.setAttribute('data-protocol', window.location.protocol);

      function toggleDeviceMode(mode) {
        const attr = 'data-device';
        if (mode || !document.body.getAttribute(attr))
          document.body.setAttribute(attr, mode || 'mobile');
        else
          document.body.removeAttribute(attr);
      }

      {
        let styles = window.getComputedStyle(document.body);
        let val = styles.getPropertyValue("--device").trim();
        if (val !== '')
          toggleDeviceMode(val);
      }

      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape')
          showHelp(null);
      });

      let varNo = 0, errorElement;

      function enterKey(event) {
        event.preventDefault();
        let inputText = inputElement.textContent;
        inputText = inputText.split('\u00a0'). join(' ');  // NBSP to space

        try {
          if (errorElement)
            errorElement.remove();
          let expr = globalScope.parseSExpr(inputText);
          let evaluated = globalScope._eval(expr, globalScope);
          let evaluatedString = globalScope.string(evaluated);

          let div = document.createElement('div');
          div.setAttribute('class', 'input');
          let span = document.createElement('span');
          let name = `?${varNo}`;
          globalScope[globalScope.Atom(name)] = expr;
          span.textContent = name;
          div.appendChild(span);
          let innerDiv = document.createElement('div');
          for (let pgf of newlinesToPgf(inputText))
            innerDiv.appendChild(pgf);
          div.appendChild(innerDiv);
          outputElement.appendChild(div);
          
          div = document.createElement('div');
          div.setAttribute('class', 'result');
          span = document.createElement('span');
          name = `=${varNo}`;
          globalScope[globalScope.Atom(name)] = evaluated;
          span.textContent = name;
          div.appendChild(span);
          innerDiv = document.createElement('div');
          for (let pgf of newlinesToPgf(evaluatedString))
            innerDiv.appendChild(pgf);
          div.appendChild(innerDiv);
          outputElement.appendChild(div);
          div.scrollIntoView();

          ++varNo;
          inputElement.textContent = "";
        } catch (error) {
          errorElement = document.createElement('div');
          errorElement.setAttribute('class', 'error');
          let div = document.createElement('div');
          div.textContent = String(error)
          errorElement.appendChild(div);
          outputElement.appendChild(errorElement)
          errorElement.scrollIntoView();
        }
      }

      function newlinesToPgf(text) {
        let res = [], lines = text.split('\n');
        for (let line of lines) {
          let element = document.createElement('p');
          element.textContent = line;
          res.push(element);
        }
        return res;
      }

      inputElement.addEventListener('keydown', function(event) {
        if (event.key === 'Enter')
          enterKey(event);
      });
      inputElement.addEventListener('blur', function(evt) {
        // TODO
      });

      if ('serviceWorker' in navigator && window.location.protocol === 'https:')
        navigator.serviceWorker.register('service-worker.js');

      try { loadState(); } catch (e) {} // inconvenient to crash while loading
   </script>
  </body>
</html>