<!DOCTYPE html>
<!--
  SchemeJS: Scheme in JavaScript

  Copyright 2021 Stan Switzer
    This work is licensed under a Creative Commons Attribution-ShareAlike
    4.0 International License. https://creativecommons.org/licenses/by-sa/4.0/
-->
<html>
  <head>
    <title>SchemeJS: Scheme in JavaScript</title>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="viewport" content="width=device-width">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <meta name="format-detection" content="telephone=no">
    <link rel="apple-touch-icon" href="icon128.png">
    <link rel="manifest" href="manifest.webmanifest">
    <base target="_blank"> <!-- all links open in a new tab/page -->
    <style type="text/css">
      html {
        -webkit-text-size-adjust: none
      }

      * { /* input elements lay out bizarrely without this since their borders aren't part of their size */
        box-sizing: border-box;
      }

      body {
        padding: .2em .5em;
        margin: 0em 0em;
        background-color: #f8f8f8;
        text-size-adjust: none;   /* keep mobile browsers from getting sneaky with sizing */
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
      }
      html, table  {
        font: 110% caption, sans-serif;
      }
      @media all and (orientation:landscape) {
        /* iPhone crowds the screen in portrait but has lots of padding in landscape
           because they don't give you the slot or curved corner areas. So kill the padding there. */
        body[data-device="mobile"] {
          padding: 0px 0px;
        }
      }

      /*
       * A trick to let the app switch to mobile mode on the fly.
       * Javascript flips the --device property into the
       * body element's data-device attribute, but the app
       * can change it later.
       */
      @media (hover: none) {
        body {--device: mobile;}
      }
      body:not([data-device="mobile"]) .mobile-only {
        display: none;
      }
      body[data-device="mobile"] .desktop-only {
        display: none;
      }
      body:not([data-protocol="file:"]) .local-only {
        display: none;
      }
      body[data-protocol="file:"] .remote-only {
        display: none;
      }

      /*
       * Initially-hidden help content.
       * Help contains a custom <close-button> and
       * a <div> for help content which is made scrollable.
       */
      div.help {
        padding: 0em 1em;
        background-color: #e8e8e8;
        position: absolute;
        display: none;
        top: 10%;
        left: 45%;
        right: .5em;
        bottom: .5em;
        border: .15em solid black;
        border-radius: .4em;
      }
      body[data-device="mobile"] div.help {
        padding: 0 .5em;  /* closer padding of help on mobile; every pixel counts */
      }
      div.help > close-button {
        color: #0005;  /* rather transparent black */
        font-size: 150%;
        --close-button-x-thick: 35%;
        position: absolute;
        top: .3em;
        right: .3em;
        transition: .25s;
      }
      div.help > close-button:hover {
        font-size: 160%;
        color: black;
      }
      div.help > div {
        overflow-y: auto;
        height: 100%;
      }

      .help dl,
      .help dl dt,
      .help dl dd {
        display: block;
        /*
         * "overflow:auto" creates a block formatting context while "dislpay:block" does not!
         * I *think* "contain: paint" is more sensible, though.
         * Look up "CSS block formatting context." It's wild!
         */
        /* overflow: auto; */
        contain: paint;
      }
      .help dl {
        margin: .25em 0 .25em 0;
      }
      .help dl dt {
        float: left;
        clear: right;
        margin-inline-end: 1ch;
      }
      .help dl dd {
        float: right;
        margin-inline-start: unset;
        --definition-margin: 10ch;
        width: calc(100% - var(--definition-margin));
      }
      .help dl dd,
      .help dl dt {
        padding-top: .5em;
      }
      .help dl .heading {
        font-weight: bold;
      }
      .help dd p {
        margin: .5em 0 .5em 0;
      }

      .help dl p.impl,
      .help dl p.value {
        color: #555;
      }

      .help .example {
        font-style: italic;
      }

      .help #builtins dd {
        font-style: italic;
      }
      .help #builtins dd p {
        font-style: normal;
      }

      #help-details dl dd {
        --definition-margin: 5ch
      }

      .help ul {
        padding-left: 1.25em;
      }
      .help ul > li {
        margin: .5em;
      }

      code {
        font-style: italic;
        font-family: caption, sans-serif;
      }

      /*
       * Makes a <span> into a "button"
       */
      span.button {
        display: inline-block;
        cursor: pointer;
        padding: .2em .6em;
        background: #44f;
        border-radius: .4em;
        color: white;
      }
      span.button:hover {
        background: #0000dd;
      }
      span.button:active {
        background: #0000cc;
      }
      span.padded-button {
        padding: .2em 1.5ch;
      }

      /* greasy way to make a text-delete button in the input box */
      .clear-text-button {
        position: relative;
        width: 0;
      }
      .clear-text-button > close-button {
        position: absolute;
        bottom: .15em;
        left: -2em;
        color: white;
        --close-button-box-color: #8e8d92;
        --close-button-box-radius: 50%;
        --close-button-x-thick: 25%;
        --close-button-x-size: 55%;
        padding: .05em .4em;
      }

      /* Looks like a link but is actually a "button" */
      span.linklike {
        color: #00d;
        cursor: pointer;
        text-decoration: underline;
      }

      #container {
        display: flex;
        flex-flow: column nowrap;
        overflow: hidden;
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        margin: 0;
        padding: .25em .25em .25em .25em;
      }

      #header {
        display: flex;
        flex: 0 10 auto;
        flex-flow: row nowrap;
        width: 100%;
      }

      #header #title {
        flex: 1 0 auto;
        align-self: flex-end;
        xxmargin-bottom: .25em;
        font-size: 160%;
      }
      #lambda {
        font-size: 150%;
        margin-right: .2em;
      }

      #header #about {
        flex: 0 0 auto;
      }

      #output {
        /* https://geon.github.io/programming/2016/02/24/flexbox-full-page-web-app-layout */
        flex: 1 1 10em;
        overflow: scroll;
        justify-content: flex-end;
        margin-top: 0.1em;
        padding: .15em .15em .15em .15em;
        width: 100%;
        background-color: #ccc;
        border: .1em solid;
        border-radius: .4em;
      }

      #output p {
        margin: 0;
      }

      #output > div {
        position: relative;  /* so that the span can be positioned absolutely */
      }
      #output > div > div {
        overflow: scroll;
        max-height: 10em;
        margin-top: 0.1em;
        padding: .5em .5em .5em .5em;
        min-height: 2em;
        border: .1em solid;
        border-radius: .4em;
        margin-top: 0.25em;
        padding: .5em .5em .5em .5em;
      }

      #output > div.result > div {
        background-color: #ddd;
        margin-left: 1em;
      }

      #output > div.input > div {
        background-color: #eee;
      }

      #output > div.error > div {
        background-color: #fbb;
      }

      #output > div > span:first-child {
        position: absolute;  /* parent div must be position: relative */
        top: 0;
        right: 0;
        margin: 0.3em 0.3em 0 0;
        padding: 0.1em 0.25em 0.1em 0.25em;
        font-size: 90%;
        border: .1em solid;
        border-radius: .4em;
        background-color: #bbb;
      }

      /* The input box */
      #input {
        flex: 0 0 4em;
        margin-top: 0.25em;
        padding: .5em .5em .5em .5em;
        width: 100%;
        border: .1em solid;
        border-radius: .4em;
        background-color: #eee;
      }
      #input .match-token {
        background-color: #fb8;
        border: 1px solid;
        border-color: #444;
        padding: 0 1px 0 1px;
      }
      #input .error-tokens {
        background-color: #f88;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="header">
        <div id="title"> <span id="lambda">&lambda;</span> SchemeJS: Scheme in JavaScript </div>
        <div id="about">
          <span class="button" style="font-size: 120%;" onclick="showHelp('help-about')"> ? </span>
        </div>
      </div>
      <div id="output">
      </div>
      <div id="input" spellcheck="false">
      </div>
    </div>
    <div class="help" id="help-about">
      <close-button onclick="showHelp(null)"></close-button>
      <div>
        <h2> SchemeJS: Scheme in JavaScript </h2>
        <p> JavaScript has dynamic typing, functions, closures, and a JIT with
            a small army of crack programmers optimizing its performance.
            It’s an ideal runtime for Lisp.
            All it lacks is cons cells, an s-expression parser and printer,
            eval/apply, and a handful of Lisp primitives.
        <p> Oh, and a compier that compiles Scheme down to perfectly normal
            JavaScript functions that the JIT can work its magic on.
        <p> SchemeJS fills that gap.
        <p> It’s hard to keep JavaScript objects from sneaking into the
            Scheme world, so I decided to invite them in as first-class.
            SchemeJS is fully Lisp <i>and</i> fully JavaScript.
        <p> Learn about
            <span class="linklike" onclick="showHelp('help-builtin')"">built-in Scheme definitions</span> and
            <span class="linklike" onclick="showHelp('help-details')"">implementation details</span>.
      </div>
    </div>
    <div class="help" id="help-details">
      <close-button onclick="showHelp(null)"></close-button>
      <div>
        <h2> Implementation Details </h2>
        <p>
        <h3> Key Features </h3>
        <dl>
          <dt>  JavaScript Integration
          <dd>  Scheme and JavaScript have full and fluent access to each other's objects.
          <dd>  Notations for JavaScript Object and Array literals.
          <dd>  Core Scheme primitives are implemented directly on fundamental
                JavaScript primitives such as function closures and prototype resolution.
                These are the things that JavaScript JITs optimize most thouroughly.
          <dd>  Scheme lists are iterable in JavaScript and JavaScript iterables can be
                viewed as Scheme lists, either directly or lazily.
          <dd>  Scheme can invoke any JavaScript function natively and Scheme closures
                are JavaScript functions by default, so can be called directly by JavaScript.
          <dt>  Partial Function Application
          <dd>  Functions, whether user-defined, compiled, or implemented in JavaScript, when
                invoked with fewer than their defined number of evaluated parameters result
                in a <i>closure</i> that binds the given arguments.
                For instance, <code>(+ 5)</code> results in a function (closure) that
                adds 5 to its argument(s).
          <dt>  Macros
          <dd>  Users can define "special forms" which take a specified number of evaluated parameters.
          <dt>  Rest Parameters
          <dd>  A function defined as <code>(define (fn p1 p2 . p3) form ...)</code> takes two
                normal parameters (<i>p1</i> and <i>p2</i>) and recieves a third parameter <i>p3</i>,
                that recieves a list of the remaining arguments.
            <p> Similarly, a lambda of the form <code>(&lambda; (p1 p2 . p3) form ...)</code> has a
                rest parameter <i>p3</i>.
          <dt>  Curry Notation
          <dd>  If you like Curry notation, go ahead and use it!
                <code>(&lambda;x.(+ x 2))</code>. The evaluator and printer
                both understand it.
          <dt>  Lazy Lists and Map Functions
          <dd>  JavaScript iterators can be turned into lazy cons cells that don't fetch
                the next object until someone invokes <i>cdr</i>.
            <p> Lazy "map" is the same, but in addition the mapping function is not applied
                until someone invoke invokes <i>car</i> on the mapped list (<i>somewhat TBD</i>).
          <dt>  Compiler
          <dd>  A compiler that transforms Scheme into perfectly normal JavaScript that the
                JIT can go to town on.
          <dd>  Tail-call optimization <i>(coming soon!)</i>.
          <dt>  Easly Embedded
          <dd>  SchemeJS is a JavaScript module designed to be easily embedded into
                other applications.
                It comes with a node-js based CLI/REPL and this Web-based REPL;
                they are just simple embeddings of the SchemeJS runtime.
        </dl>
        <p> A-B-C. A-Always. B-Be. C-Coding.
        <p> Copyright &copy; 2021, Stan Switzer
        <div style="width: 100%">
          This work is licensed under a
          <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
            Creative Commons Attribution-ShareAlike 4.0 International License</a>.
          <br> Find source on
          <a href="https://github.com/sjswitzer/SchemeJS">GitHub</a>
          <p></p>
        </div>
      </div>
    </div>
    <div class="help" id="help-builtin">
      <close-button onclick="showHelp(null)"></close-button>
      <div>
        <h2> Built-In Functions and Constants </h2>
          <dl id="builtins">
            <dt class="heading"> Symbol
            <dd class="heading"> Description
            <!-- definitions inserted here when SchemeJS module is loaded -->
         </dl>
      </div>
    </div>
    <div style="display: none !important">
      <dd id="defn-_star_catch"><div>
        (*catch "tag" form ...)
        <p> SIOD-style catch.
            Evaluates the forms until one of them calls
            <code>(*throw "tag" value)</code>.
            Returns "value" if the tags match; otherwise the exception propagates.
      </div></dd>
      <dd id="defn-_star_catch"><div>
        (*throw "tag" value)
        <p> SIOD-style throw.
            Throws the value with the given tag.
            An enclosing <code>(*catch "tag" form ...)</code> will
            return "value" if the tags match; otherwise the exception propagates.
      </div></dd>
      <dd id="defn-catch"><div>
        (catch catch-clause forms)
        <p> where <i>catch-clause</i> is:</p>
        (error type forms)
        <p> Java/JavaScript-style catch.
        <p> Evaluates the forms until one of them calls <code>(throw obj)</code>.
            If the <i>type</i> matches the thrown object,
            the <i>catch-clause</i> forms are evaluated with the thrown object bound
            to "<i>error</i>".
            If <i>type</i> is an object, the catch matches if the object is an instance
            of that object; it <i>type</i> is a string, the catch matches if it is the JavaScript
            "typeof" the thrown object.
        <p> For example:
        <p class="example">
            (catch (e "string" (+ "thrown: " e))<br>
            &nbsp;&nbsp; (+ 1 2)<br>
            &nbsp;&nbsp;  (+ 3 (throw "ha ha!"))<br>
            )
      </div></dd>
      <dd id="defn-_star_catch"><div>
        (*throw "tag" value)
        <p> Java/JavaScript-style-style throw.
            Throws the value with the given tag.
            An enclosing <code>(*catch "tag" form ...)</code> will
            return "value" if the tags match; otherwise the exception propagates.
      </div></dd>
      <dd id="defn-_star_e_star_"><div>
        Euler's constant and the base of natural logarithms
      </div></dd>
      <dd id="defn-_star_ln10_star_"><div>
        Natural logarithm of 10
      </div></dd>
      <dd id="defn-_star_log10e_star_"><div>
        Base-10 logarithm of Euler's constant
      </div></dd>
      <dd id="defn-_star_log2e_star_"><div>
        Base-2 logarithm of Euler's constant
      </div></dd>
      <dd id="defn-_star_pi_star_"><div>
        Ratio of the a circle's circumference to its diameter (&pi;)
      </div></dd>
      <dd id="defn-_star_sqrt1_2_star_"><div>
        Square root of 1/2
      </div></dd>
      <dd id="defn-_star_sqrt2_star_"><div>
        Square root of 2
      </div></dd>
      <dd id="defn-_star_ln2_star_"><div>
        Natural logarithm of 2
      </div></dd>
      <dd id="defn-abs"><div>
        (abs x)
        <p> Absolute value of x.
      </div></dd>
      <dd id="defn-acos"><div>
        (acos x)
        <p> Arccosine of x in radians.
      </div></dd>
      <dd id="defn-acosh"><div>
        (acosh x)
        <p> Hyperbolic arccosine of x in radians.
      </div></dd>
      <dd id="defn-asin"><div>
        (asin x)
        <p> Arcsine of x in radians.
      </div></dd>
      <dd id="defn-asinh"><div>
        (asinh x)
        <p> Hyperbolic arcsine of x in radians.
      </div></dd>
      <dd id="defn-atan"><div>
        (atan x)
        <p> Arctangent of x in radians.
      </div></dd>
      <dd id="defn-atanh"><div>
        (atanh x)
        <p> Hyperbolic arctangent of x in radians.
      </div></dd>
      <dd id="defn-atan2"><div>
        (atan2 y x)
        <p> Angle in radians from the positive x axis and the ray to the point (x, y).
            Does not suffer from divide-by-zero issues as <i>tan</i> would.
      </div></dd>
      <dd id="defn-sqrt"><div>
        (sqrt x)
        <p> Square root of x.
      </div></dd>
      <dd id="defn-cbrt"><div>
        (cbrt x)
        <p> Cube root of x.
      </div></dd>
      <dd id="defn-xxx"><div>
        xxx
      </div></dd>
      <dd id="defn-xxx"><div>
        xxx
      </div></dd>
      <dd id="defn-xxx"><div>
        xxx
      </div></dd>
      <dd id="defn-clz32"><div>
        (clz32 x)
        <p> Number of leading zeros in the binary representation of x
            considered as a 32-bit integer.
      </div></dd>
      <dd id="defn-cos"><div>
        (cos x)
        <p> Cosine of x in radians.
      </div></dd>
      <dd id="defn-cosh"><div>
        (cosh x)
        <p> Hyperbolic cosine of x in radians.
      </div></dd>
      <dd id="defn-expm1"><div>
        (expm1 x)
        <p> The value <code>(- (exp x) 1)</code>, avoiding numerical anomalies.
      </div></dd>
      <dd id="defn-exp"><div>
        (exp x)
        <p> Euler's number to the power x.
      </div></dd>
      <dd id="defn-floor"><div>
        (floor x)
        <p> The largest integer less than or equal to x.
      </div></dd>
      <dd id="defn-ceil"><div>
        (ceil x)
        <p>The smallest integer greater than or equal to x.
      </div></dd>
      <dd id="defn-fround"><div>
        (fround x)
        <p> The closest single precision floating point representation of x.
      </div></dd>
      <dd id="defn-hypot"><div>
        (hypot value ...)
        <p> The square root of the sum of the squares of the arguments.
      </div></dd>
      <dd id="defn-imul"><div>
        (imul x y)
        <p> Result of the multiplication of x and y considered as 32-bit integers.
      </div></dd>
      <dd id="defn-log"><div>
        (log x)
        <p> The natural logarithm of x.
      </div></dd>
      <dd id="defn-xxx"><div>
        xxx
        <p> xxx
      </div></dd>
      <dd id="defn-xxx"><div>
        xxx
        <p> xxx
      </div></dd>
      <dd id="defn-xxx"><div>
        xxx
        <p> xxx
      </div></dd>
      <dd id="defn-xxx"><div>
        xxx
        <p> xxx
      </div></dd>
      <dd id="defn-add"><div>
        (+ value value ...)
        <p> Adds the values.
      </div></dd>
      <dd id="defn-sub"><div>
        (- value ...)
        <p> Subtracts a series of values from the first value.
            If there is only one argument, negates the value.
      </div></dd>
      <dd id="defn-mul"><div>
        (* value value ...)
        <p> Multiplies a series of values.
      </div></dd>
      <dd id="defn-div"><div>
        (/ value ...)
        <p> Divides a series of values from the first value.
            If there is only one argument, returns the reciprocal.
      </div></dd>
      <dd id="defn-rem"><div>
        (% value value)
        <p> Remainder of the first value divided by the second.
      </div></dd>
      <dd id="defn-pow"><div>
        (** value value)
        <p> Exponentiates the first value by the second.
      </div></dd>
      <dd id="defn-and"><div>
        (&& value value ...)
        <p> Evaluates its arguments until one of them is false.
            Results in the first "falsey" value; otherwise the last value.
            Evaluation ends when a false value is found.
            "Falsey" values are
            <code>false</code>, <code>nil</code>, <code>undefined</code> and
            <code>null</code>; unlike JavaScript,
            zero, NaN and "" are <i>not</i> falsey.
      </div></dd>
      <dd id="defn-or"><div>
        (|| value value ...)
        <p> Evaluates its arguments until one of them is true.
          Results in the first "truthy" value; otherwise the last value.
          Evaluation ends when a true value is found.
          "Falsey" values are
          <code>false</code>, <code>nil</code>, <code>undefined</code> and
          <code>null</code>; unlike JavaScript,
          zero, NaN and "" are <i>not</i> falsey.
          Everything else is "truthy."
      </div></dd>
      <dd id="defn-bit-and"><div>
        (& value value ...)
        <p> Bitwise "and" of the values considered as 32-bit integers.
      </div></dd>
      <dd id="defn-bit-or"><div>
        (| value value ...)
        <p> Bitwise "or" of the values considered as 32-bit integers.
      </div></dd>
      <dd id="defn-bit-xor"><div>
        (^ value value ...)
        <p> Bitwise exclusive "or" of the values considered as 32-bit integers.
      </div></dd>
      <dd id="defn-bit-not"><div>
        (~ value)
        <p> Bitwise not of the value considered as a 32-bit integer.
      </div></dd>
      <dd id="defn-bit-shl"><div>
        (&lt;&lt; value shift)
        <p> <i>Value</i> left-shifted "shift" bits, bith considered as 32-bit integers.
      </div></dd>
      <dd id="defn-bit-shr"><div>
        (&gt;&gt; value shift)
        <p> <i>Value</i> arithmetcally right-shifted "shift" bits, bith considered as 32-bit integers.
            The sign bit fills from the left.
      </div></dd>
      <dd id="defn-bit-ushr"><div>
        (&gt;&gt;&gt; value shift)
        <p> <i>Value</i> logically right-shifted "shift" bits, bith considered as 32-bit integers.
          Zero bits fill from the left.
      </div></dd>
      <dd id="defn-ash"><div>
        (ash value shift)
        <p> Shifts left if <i>shift</i> is positive.
            Shifts arithmetcally right if <i>shift</i> is negative;
            sign bits fill from the left.
      </div></dd>
      <dd id="defn-append"><div>
        (append list ...)
        <p> Appends the specified lists or iterable JavaScript objects, forming a new list.
      </div></dd>
      <dd id="defn-apply"><div>
        (apply function args [scope])
        <p> Applies the function to the arguments in the given scope.
            "scope" is optional; the default is the current scope.
      </div></dd>
      <dd id="defn-begin"><div>
        (begin form ...)
        <p> Evaluates the forms sequentially, returning the value of the last form.
      </div></dd>
      <dd id="defn-bigintP"><div>
        (bigint? obj)
        <p> Returns <code>true</code> if <i>obj</i> is a JavaScript BigInt.
      </div></dd>
      <dd id="defn-booleanP"><div>
        (boolean? obj)
        <p> Returns <code>true</code> if <i>obj</i> is a boolean.
      </div></dd>
      <dd id="defn-function?"><div>
        (boolean? obj)
        <p> Returns <code>true</code> if <i>obj</i> is a JavaScript function.
      </div></dd>
      <dd id="defn-butlast"><div>
        (butlast list)
        <p> A copy of <i>list</i> excepting the last element.
      </div></dd>
      <dd id="defn-caaar"><div>
        (caaar list)
        <p> Shorthand for: <code>(car (car (car list)))</code>.
      </div></dd>
      <dd id="defn-caadr"><div>
        (caadr list)
        <p> Shorthand for: <code>(car (car (cdr list)))</code>.
      </div></dd>
      <dd id="defn-caar"><div>
        (caar list)
        <p> Shorthand for: <code>(car (car list))</code>.
      </div></dd>
      <dd id="defn-cadar"><div>
        (cadar list)
        <p> Shorthand for: <code>(car (cdr (car list)))</code>.
      </div></dd>
      <dd id="defn-caddr"><div>
        (caddr list)
        <p> Shorthand for: <code>(car (cdr (cdr list)))</code>.
      </div></dd>
      <dd id="defn-cadr"><div>
        (cadr list)
        <p> Shorthand for: <code>(car (cdr list))</code>.
      </div></dd>
      <dd id="defn-cons"><div>
        (cons first rest)
        <p> Returns a new list object with <i>first</i> as the "car" and <i>rest</i> as the "cdr."
      </div></dd>
      <dd id="defn-car"><div>
        (car list)
        <p> First element of <i>list</i>.
      </div></dd>
      <dd id="defn-cdr"><div>
        (cdr list)
        <p> Second and subsequent elements of <i>list</i>.
      </div></dd>
      <dd id="defn-cdaar"><div>
        (cdaar list)
        <p> Shorthand for: <code>(cdr (car (car list)))</code>.
      </div></dd>
      <dd id="defn-cdddr"><div>
        (cdddr list)
        <p> Shorthand for: <code>(cdr (cdr (cdr list)))</code>.
      </div></dd>
      <dd id="defn-cdadr"><div>
        (cdadr list)
        <p> Shorthand for: <code>(cdr (car (cdr list)))</code>.
      </div></dd>
      <dd id="defn-cdar"><div>
        (cdar list)
        <p> Shorthand for: <code>(cdr (car list))</code>.
      </div></dd>
      <dd id="defn-cddar"><div>
        (cddar list)
        <p> Shorthand for: <code>(cdr (cdr (car list)))</code>.
      </div></dd>
      <dd id="defn-cdddr"><div>
        (cdddr list)
        <p> Shorthand for: <code>(cdr (cdr (cdr list)))</code>.
      </div></dd>
      <dd id="defn-cddr"><div>
        (cddr list)
        <p> Shorthand for: <code>(cdr (cdr list))</code>.
      </div></dd>
      <dd id="defn-closureP"><div>
        (closure? obj)
        <p> True if <i>obj</i> is a Scheme closure.
      </div></dd>
      <dd id="defn-CompileError"><div>
        <p> Thrown when the compiler finds an error.
      </div></dd>
      <dd id="defn-CompileError"><div>
        <p> Thrown when the there is an error evaluating Scheme functions.
      </div></dd>
      <dd id="defn-cond"><div>
        (cond cond-clause ...)
        <p> where <i>cond-clause</i> is:</p>
        (predicate form ...)
        <p> Evaluates each predicate sequentially until one is true then
            evaluates the forms in that clause, returning the value
            of the last form.
        <p class="example">
          (cond <br>
          &nbsp;&nbsp; ((< 6 4) "a") <br>
          &nbsp;&nbsp; ((< 4 4) "b") <br>
          &nbsp;&nbsp; ((< 3 4) "c") <br>
          &nbsp;&nbsp; ((< 2 4) "d"))
      </div></dd>
      <dd id="defn-copy-list"><div>
        (copy-list list)
        <p> Returns a new list that is an element-wise shallow copy of <i>list</i>,
            which can be a Scheme list or JavaScript iterable.
      </div></dd>
      <dd id="defn-xxx"><div>
        xxx
        <p> xxx
      </div></dd>
      <dd id="defn-apropos"><div>
        (apropos ["substring"])
        <p> A list of globally-defined functions and values.
            If an optional "substring" parameter is given, it returns only definitions
            whose name contains that substring.
      </div></dd>
      <dd id="defn-aref"><div>
        (@ index array)
        <p> Indexes into the JavaScript array by the given index. </p>
        (@ "prop" obj)
        <p> The value of the property "prop" in the given object.
      </div></dd>
      <dd id="defn-arefP"><div>
        (@? index array)
        <p> The value of the property "prop" in the given object or undefined if the array is
            undefined or null.</p>
            (@ "prop" obj)
            <p> The value of the property "prop" in the given object or undefined if the array is
              undefined or null.
          </div></dd>
      <dd id="defn-arrayP"><div>
        (array? obj)
        <p> True if the object is a JavaScript Array.
      </div></dd>
      <dd id="defn-xxx"><div>
        xxx
        <p> xxx
      </div></dd>
      <dd id="defn-xxx"><div>
        xxx
        <p> xxx
      </div></dd>
      <dd id="defn-xxx"><div>
        xxx
        <p> xxx
      </div></dd>
      <dd id="defn-xxx"><div>
        xxx
        <p> xxx
      </div></dd>
      <dd id="defn-xxx"><div>
        xxx
        <p> xxx
      </div></dd>
      <dd id="defn-xxx"><div>
        xxx
        <p> xxx
      </div></dd>
      <dd id="defn-xxx"><div>
        xxx
        <p> xxx
      </div></dd>
      <dd id="defn-false"><div>
        false
        <p> The canonical "false" value.
            Only <code>false</code>, <code>nil</code>, <code>undefined</code> and
            <code>null</code> are considered false; unlike JavaScript,
            zero, NaN and "" are <i>not</i> considered false.
            Everything else is "true."
      </div></dd>
      <dd id="defn-true"><div>
        true
        <p> The canonical "true" value.
            Only <code>false</code>, <code>nil</code>, <code>undefined</code> and
            <code>null</code> are considered false; unlike JavaScript,
            zero, NaN and "" are considered true.
            Everything else is "true."
      </div></dd>
      <dd id="defn-intern"><div>
        (intern "str")
        <p> Returns a Scheme atom named "str".
      </div></dd>
      <dd id="defn-Date"><div>
        Date
        <p> The standard JavaScript Date class.
      </div></dd>
      <dd id="defn-Float32Array"><div>
        Float32Array
        <p> The standard JavaScript Float32Array class.
      </div></dd>
      <dd id="defn-Float64Array"><div>
        Float64Array
        <p> The standard JavaScript Float64Array class.
      </div></dd>
      <dd id="defn-Function"><div>
        Function
        <p> The standard JavaScript Function class.
      </div></dd>
      <dd id="defn-Array"><div>
        Array
        <p> The standard JavaScript Array class.
      </div></dd>
      <dd id="defn-ArrayBuffer"><div>
        ArrayBuffer
        <p> The standard JavaScript ArrayBuffer class.
      </div></dd>
      <dd id="defn-Atomics"><div>
        Atomics
        <p> The standard JavaScript Atomics class.
      </div></dd>
      <dd id="defn-Math"><div>
        max-height
        <p> The standard JavaScript Math object.
      </div></dd>
      <dd id="defn-BigInt"><div>
        BigInt
        <p> The standard JavaScript BigInt class.
      </div></dd>
      <dd id="defn-BigInt64Array"><div>
        BigInt64Array
        <p> The standard JavaScript BigInt64Array.
      </div></dd>
      <dd id="defn-BigUint64Array"><div>
        BigUint64Array
        <p> The standard JavaScript BigUint64Array class.
      </div></dd>
      <dd id="defn-Boolean"><div>
        Boolean
        <p> The standard JavaScript Boolean class.
      </div></dd>
      <dd id="defn-DataView"><div>
        DataView
        <p> The standard JavaScript DataView class.
      </div></dd>
      <dd id="defn-decodeURI"><div>
        decodeURI
        <p> The standard JavaScript function decodeURI.
      </div></dd>
      <dd id="defn-decodeURIComponent"><div>
        decodeURIComponent
        <p> The standard JavaScript function decodeURIComponent.
      </div></dd>
      <dd id="defn-encodeURI"><div>
        encodeURI
        <p> The standard JavaScript function encodeURI.
      </div></dd>
      <dd id="defn-encodeURIComponent"><div>
        encodeURIComponent
        <p> The standard JavaScript function encodeURIComponent.
      </div></dd>
      <dd id="defn-define"><div>
        (define a form)
        <p> Defines a global-scope variable <i>a</i> with the evaluated value of <i>form</i>.</p>
        (define (fn param...) form ...)
        <p> Defines a global-scope function <i>fn</i> with parameters <i>param...</i>
            which evaluates the forms in the context of the bound parameters.
      </div></dd>
      <dd id="defn-delete"><div>
        (delete a b)
        <p> Deletes property or array element <i>b</i> from JavaScript object <i>a</i>.
      </div></dd>
      <dd id="defn-eval"><div>
        (eval form [scope])
        <p> Evaluates <i>form</i> in the given <i>scope</i>.
            Default is the scope of the caller.
      </div></dd>
      <dd id="defn-eval-string"><div>
        (eval "str" [scope])
        <p> Parses the evaluates <i>"str"</i> in the given <i>scope</i>.
            Default is the scope of the caller.
      </div></dd>
      <dd id="defn-xxx"><div>
        xxx
        <p> xxx
      </div></dd>
      <dd id="defn-xxx"><div>
        xxx
        <p> xxx
      </div></dd>
      <dd id="defn-xxx"><div>
        xxx
        <p> xxx
      </div></dd>
      <dd id="defn-xxx"><div>
        xxx
        <p> xxx
      </div></dd>
    </div>
    <script type="module" src="./CloseButton.mjs"></script>
    <script type="text/javascript">
      "use strict";

      const inputElement = document.getElementById('input');
      const outputElement = document.getElementById('output');
      const builtinsElement = document.getElementById('builtins');

      let globalScope, SCHEME_VERSION, ParseIncomplete;

      onload = importSchemeAndRunREPL()
      async function importSchemeAndRunREPL() {
        let SchemeJS = await(import("./SchemeJS.mjs"));
        console.log("MODULE", SchemeJS);
        globalScope = SchemeJS.createInstance({ lambdaStr: "\u03BB", slambdaStr: "\u03BB\u03BB" });
        inputElement.contentEditable = 'true';
        SCHEME_VERSION = globalScope.VERSION;
        ParseIncomplete = globalScope.ParseIncomplete;
        buildBuiltinHelp(globalScope);
      }

      let helpStack = [];

      function showHelp(id) {
        let elts = document.querySelectorAll('div.help');
        for (let e of elts)
          e.style.display = ''; // back to inherited 'none'
        if (!id) {
          helpStack.pop();
          if (helpStack.length > 0)
            helpStack[helpStack.length-1].style.display = 'block';
          return;
        }
        id = id.split("#");
        let frag = id[1];
        id = id[0];
        let helpElement = document.getElementById(id);
        if (helpElement) {
          helpStack.push(helpElement);
          helpElement.style.display = 'block'; // inherits 'none' from "help" class
          let contentElement = helpElement.querySelector('div');
          if (contentElement) {
            contentElement.scrollTop = 0;
            if (frag) {
              let element = contentElement.querySelector(`#${frag}`);
              if (element)
                element.scrollIntoView(true);
            }
          }
        }
      }

      function buildBuiltinHelp(globalScope) {
        const IMPL_SYMBOL = globalScope["IMPL_SYMBOL"], string = globalScope.string;
        let symtab = [], helpHelper = globalScope._help_;
        let syms = Object.getOwnPropertySymbols(helpHelper);
        for (let sym of syms)
          symtab.push({ key: keyFor(sym), ...helpHelper[sym] });
        symtab.sort((a, b) => a.key < b.key ? -1 : 1);
        for (let { atoms, value } of symtab) {
          for (let atom of atoms)
            builtinsElement.appendChild(textElement('dt', atom.description));
          let name = atoms[0].description, elementId = "defn-" + name;
          for (;;) {
            let prevElementId = elementId;
            elementId = elementId.replace('*', '_star_').replace('?', 'P');
            if (elementId === prevElementId) break;
          }
          let dd = document.getElementById(elementId);
          if (!dd)
            dd = textElement('dd', "TBD");
          builtinsElement.appendChild(dd);
          if (typeof value === 'function') {
            let impl = value[IMPL_SYMBOL];
            if (!impl) impl = string(value);
            if (impl.length < 50)
              dd.appendChild(textElement('p', `Impl: ${impl}`, 'impl'));
          } else {
            let valStr = string(value);
            if (valStr.length < 50)
              dd.appendChild(textElement('p', `Value: ${string(value)}`, 'value'));
          }
        }
        function keyFor(atom) {
          let key = atom.description;
          key = key.replace('*', '');
          key = key.toLowerCase();
          return key;
        }
        function textElement(type, text, cls) {
          let element = document.createElement(type);
          element.textContent = text;
          if (cls)
            element.setAttribute('class', cls);
          return element;
        }
      }

      const LOCAL_STORAGE_KEY = `SchemeJS-${location.pathname}`;
      const appVersion = "1.1";
      let persistedState = {};

      function saveState() {
        const localStorage = window.localStorage;
        if (!localStorage)
          return false;
        persistedState.version = appVersion;
        let json = JSON.stringify(wad);
        try {
          localStorage.setItem(LOCAL_STORAGE_KEY, json);
          return true;
        }
        catch (e) {
        }
        return false;
      }

      function loadState() {
        const localStorage = window.localStorage;
        if (!localStorage)
          return false;
        let json = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (!json)
          return false;
        let wad;
        try {
          wad = JSON.parse(json);
        } catch (_) {
          //  ¯\_(ツ)_/¯
        }
        if (typeof wad !== 'object')
          return false;
        let appVer = appVersion.split('.'), saveVer = wad.version.split('.');
        if (!(Number(saveVer[0]) <= Number(appVer[0])))  // handles undefined implicitly
          return false;
        persistedState = wad;
        return true;
      }

      document.body.setAttribute('data-protocol', window.location.protocol);

      function toggleDeviceMode(mode) {
        const attr = 'data-device';
        if (mode || !document.body.getAttribute(attr))
          document.body.setAttribute(attr, mode || 'mobile');
        else
          document.body.removeAttribute(attr);
      }

      {
        let styles = window.getComputedStyle(document.body);
        let val = styles.getPropertyValue("--device").trim();
        if (val !== '')
          toggleDeviceMode(val);
      }

      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape')
          showHelp(null);
      });

      let varNo = 0, errorElement, highlightElement;
      const NBSP = '\u00a0';

      function handleInput(event, enterKey) {
        let inputText = getInputText(), replHints = {};
        if (errorElement) {
            errorElement.remove();
            errorElement = undefined;
        }
        if (highlightElement) {
          highlightElement.replaceWith(highlightElement.textContent);
          highlightElement = undefined;
          inputElement.normalize();
        }
        try {
          let expr = globalScope.parseSExpr(inputText, { replHints });
          if (!enterKey) return;
          let evaluated = globalScope._eval(expr, globalScope);
          let evaluatedString = globalScope.string(evaluated);

          let div = document.createElement('div');
          div.setAttribute('class', 'input');
          let span = document.createElement('span');
          let name = `?${varNo}`;
          globalScope[globalScope.Atom(name)] = expr;
          span.textContent = name;
          div.appendChild(span);
          let innerDiv = document.createElement('div');
          for (let pgf of newlinesToPgf(inputText))
            innerDiv.appendChild(pgf);
          div.appendChild(innerDiv);
          outputElement.appendChild(div);
          
          div = document.createElement('div');
          div.setAttribute('class', 'result');
          span = document.createElement('span');
          name = `=${varNo}`;
          globalScope[globalScope.Atom(name)] = evaluated;
          span.textContent = name;
          div.appendChild(span);
          innerDiv = document.createElement('div');
          for (let pgf of newlinesToPgf(evaluatedString))
            innerDiv.appendChild(pgf);
          div.appendChild(innerDiv);
          outputElement.appendChild(div);
          div.scrollIntoView();

          ++varNo;
          inputElement.textContent = "";
          event.preventDefault();
        } catch (error) {
          if (error instanceof ParseIncomplete) {
            let parseContext = replHints.parseContext;
            if (parseContext.length > 0) {  // It really should be!
              let matchPos = parseContext[parseContext.length-1].position;
              for (let child of inputElement.childNodes) {
                let hostElement = inputElement, textNode = child;
                if (child instanceof HTMLElement) {
                  hostElement = child;
                  textNode = child.firstChild;
                }
                let text = textNode.textContent;
                if (matchPos < text.length) {
                  console.log("TEXTNODE", textNode);
                  let toReplace = textNode.splitText(matchPos);
                  let after = toReplace.splitText(1);
                  highlightElement = document.createElement('span');
                  highlightElement.setAttribute('class', 'match-token');
                  highlightElement.textContent = toReplace.textContent;
                  hostElement.replaceChild(highlightElement, toReplace);
                  let selection = window.getSelection();
                  if (highlightElement.contains(selection.anchorNode)) {
                  // Keep the selection from collapsing into the highlighted item
                  if (after.textContent === '')
                      after.textContent = ' ';
                    selection.collapse(after);
                  }
                  break;
                }
                matchPos -= text.length + 1;  // +1 for newline
                if (matchPos < 0) break;
              }
            }
          } else {
            event.preventDefault();
            errorElement = document.createElement('div');
            errorElement.setAttribute('class', 'error');
            let div = document.createElement('div');
            div.textContent = String(error)
            errorElement.appendChild(div);
            outputElement.appendChild(errorElement)
            errorElement.scrollIntoView();
          }
        }
      }

      function newlinesToPgf(text) {
        let res = [], lines = text.split('\n');
        for (let line of lines) {
          let element = document.createElement('p');
          element.textContent = line;
          res.push(element);
        }
        return res;
      }

      function getInputText() {
        let text = '', delim = '';
        for (let child of inputElement.childNodes) {
          let childText = child.textContent;
          childText = childText.split(NBSP).join(' ');
          text += delim + childText;
          delim = '\n';
        }
        console.log("INPUT", text);
        return text;
      }

      inputElement.addEventListener('keydown', function(event) {
        let enterKey = event.key === 'Enter';
        if (enterKey) handleInput(event, enterKey);
      });
      inputElement.addEventListener('blur', function(evt) {
        // TODO
      });

      if ('serviceWorker' in navigator && window.location.protocol === 'https:')
        navigator.serviceWorker.register('service-worker.js');

      try { loadState(); } catch (e) {} // inconvenient to crash while loading
   </script>
  </body>
</html>